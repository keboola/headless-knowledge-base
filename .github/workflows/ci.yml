name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: ai-knowledge-base-42
  REGION: us-central1

jobs:
  # ============================================
  # Stage 1: Unit Tests (runs on every PR/push)
  # ============================================
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -e .[dev]
      - name: Run unit tests
        run: pytest tests/ --ignore=tests/e2e --ignore=tests/integration -v

  # ============================================
  # Stage 2a: Build slack-bot Docker Image
  # ============================================
  build-slack-bot:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: Build and push slack-bot image
        env:
          TAG: ${{ github.sha }}
        run: |
          docker build -f deploy/docker/Dockerfile.slack -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG

  # ============================================
  # Stage 2b: Build jobs Docker Image
  # ============================================
  build-jobs:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Free up disk space
        run: |
          # Remove unnecessary tools to free up ~20GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          df -h
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: Build and push jobs image
        env:
          TAG: ${{ github.sha }}
        run: |
          docker build -f deploy/docker/Dockerfile.jobs -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG

  # ============================================
  # Stage 2c: Build Gate (for branch protection)
  # ============================================
  build:
    # Gate job that passes when all build jobs complete
    # This allows branch protection to require just "build" instead of listing each build job
    needs: [build-slack-bot, build-jobs]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All build jobs completed successfully"

  # ============================================
  # Stage 3: Deploy to Staging
  # ============================================
  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy slack-bot to staging
        env:
          TAG: ${{ github.sha }}
        run: |
          gcloud run deploy slack-bot-staging \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}
      - name: Tag jobs image for staging
        env:
          TAG: ${{ github.sha }}
        run: |
          # Tag the jobs image as staging:latest for Cloud Run jobs to use
          gcloud artifacts docker tags add \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:staging

  # ============================================
  # Stage 4: E2E Tests against Staging (ALL tests)
  # ============================================
  e2e-tests-staging:
    needs: deploy-staging
    runs-on: ubuntu-latest
    env:
      # Slack configuration
      SLACK_BOT_TOKEN: ${{ secrets.STAGING_SLACK_BOT_TOKEN }}
      SLACK_USER_TOKEN: ${{ secrets.STAGING_SLACK_USER_TOKEN }}
      SLACK_SIGNING_SECRET: ${{ secrets.STAGING_SLACK_SIGNING_SECRET }}
      E2E_TEST_CHANNEL_ID: ${{ secrets.STAGING_TEST_CHANNEL_ID }}
      E2E_BOT_USER_ID: ${{ secrets.STAGING_BOT_USER_ID }}
      STAGING_BOT_URL: https://slack-bot-staging-4aosg235qq-uc.a.run.app
      # ChromaDB configuration
      CHROMA_HOST: chromadb-staging-4aosg235qq-uc.a.run.app
      CHROMA_PORT: "443"
      CHROMA_USE_SSL: "True"
      CHROMA_TOKEN: ${{ secrets.STAGING_CHROMADB_TOKEN }}
      # Vertex AI for embeddings
      EMBEDDING_PROVIDER: vertex-ai
      VERTEX_AI_PROJECT: ai-knowledge-base-42
      VERTEX_AI_LOCATION: us-central1
      # LLM configuration
      LLM_PROVIDER: gemini
      GEMINI_MODEL_ID: gemini-2.0-flash
      GCP_PROJECT_ID: ai-knowledge-base-42
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -e .[dev]
      - name: Wait for staging to be ready
        run: sleep 30
      - name: Run ALL E2E tests against staging
        run: |
          pip install pytest-timeout
          # Use timeout to force pytest to exit (it can hang after tests complete due to async cleanup)
          timeout --signal=SIGKILL 10m pytest tests/e2e/ -v -m e2e --tb=short --timeout=300 || {
            exit_code=$?
            # Exit code 137 means SIGKILL from timeout, which is OK if tests passed
            # Exit code 124 means timeout sent SIGTERM first
            if [ $exit_code -eq 137 ] || [ $exit_code -eq 124 ]; then
              echo "::warning::pytest was killed by timeout (likely hung during cleanup)"
              exit 0
            fi
            exit $exit_code
          }
        timeout-minutes: 15

  # ============================================
  # Stage 5: Auto-merge PR on success (PRs only)
  # ============================================
  auto-merge:
    needs: e2e-tests-staging
    if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge for PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

  # ============================================
  # Stage 6: Deploy to Production (main only)
  # ============================================
  deploy-production:
    needs: e2e-tests-staging
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy slack-bot to production
        env:
          TAG: ${{ github.sha }}
        run: |
          gcloud run deploy slack-bot \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}
      - name: Tag jobs image as latest for production
        env:
          TAG: ${{ github.sha }}
        run: |
          # Tag the jobs image as latest for production Cloud Run jobs
          gcloud artifacts docker tags add \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:latest
