name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: ai-knowledge-base-42
  REGION: us-central1

jobs:
  # ============================================
  # Stage 0a: AI Code Review (PRs only)
  # ============================================
  ai-review:
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
      - name: Fallback to PR branch if reviewer script missing
        if: ${{ hashFiles('scripts/ai_reviewer.py') == '' }}
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install requests
      - name: Run AI Reviewer
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "::error::GEMINI_API_KEY secret is not configured. AI review cannot run."
            exit 1
          fi
          OUTPUT=$(python scripts/ai_reviewer.py \
            --repo "$REPO" \
            --pr "$PR_NUMBER" \
            --github-token "$GITHUB_TOKEN" 2>&1) || {
            echo "$OUTPUT"
            exit 1
          }
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "Submitted review: REQUEST_CHANGES"; then
            echo "::error::AI reviewer requested changes - see review comments"
            exit 1
          fi

  # ============================================
  # Stage 0b: Security Review (PRs only)
  # ============================================
  security-review:
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install requests anthropic
      - name: Run Security Reviewer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          OUTPUT=$(python scripts/security_reviewer.py \
            --repo "$REPO" \
            --pr "$PR_NUMBER" \
            --github-token "$GITHUB_TOKEN" 2>&1) || {
            echo "$OUTPUT"
            exit 1
          }
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -qi "submitted.*REQUEST_CHANGES"; then
            echo "::error::Security reviewer requested changes - see review comments"
            exit 1
          fi

  # ============================================
  # Stage 1: Unit Tests (runs on every PR/push)
  # ============================================
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -e .[dev]
      - name: Run unit tests
        run: pytest tests/ --ignore=tests/e2e --ignore=tests/integration -v

  # ============================================
  # Stage 2a: Build slack-bot Docker Image
  # ============================================
  build-slack-bot:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: Build and push slack-bot image
        env:
          TAG: ${{ github.sha }}
        run: |
          docker build -f deploy/docker/Dockerfile.slack -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG

  # ============================================
  # Stage 2b: Build jobs Docker Image
  # ============================================
  build-jobs:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Free up disk space
        run: |
          # Remove unnecessary tools to free up ~20GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          df -h
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: Build and push jobs image
        env:
          TAG: ${{ github.sha }}
        run: |
          docker build -f deploy/docker/Dockerfile.jobs -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG

  # ============================================
  # Stage 2c: Build Gate (for branch protection)
  # ============================================
  build:
    # Gate job: requires builds + reviewer approvals (on PRs) before staging deploy
    needs: [build-slack-bot, build-jobs, ai-review, security-review]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Verify all gates passed
        env:
          EVENT_NAME: ${{ github.event_name }}
          BUILD_BOT: ${{ needs.build-slack-bot.result }}
          BUILD_JOBS: ${{ needs.build-jobs.result }}
          AI_REVIEW: ${{ needs.ai-review.result }}
          SEC_REVIEW: ${{ needs.security-review.result }}
        run: |
          echo "Build Slack Bot: $BUILD_BOT"
          echo "Build Jobs: $BUILD_JOBS"
          echo "AI Review: $AI_REVIEW"
          echo "Security Review: $SEC_REVIEW"

          # Build jobs must succeed
          [[ "$BUILD_BOT" == "success" ]] || { echo "::error::build-slack-bot failed"; exit 1; }
          [[ "$BUILD_JOBS" == "success" ]] || { echo "::error::build-jobs failed"; exit 1; }

          # For PRs: reviewers must succeed
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            [[ "$AI_REVIEW" == "success" ]] || { echo "::error::ai-review failed or not approved"; exit 1; }
            [[ "$SEC_REVIEW" == "success" ]] || { echo "::error::security-review failed"; exit 1; }
          fi

          echo "All gates passed"

  # ============================================
  # Stage 3: Deploy to Staging
  # ============================================
  deploy-staging:
    needs: build
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy slack-bot to staging
        env:
          TAG: ${{ github.sha }}
        run: |
          gcloud run deploy slack-bot-staging \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}
      - name: Tag jobs image for staging
        env:
          TAG: ${{ github.sha }}
        run: |
          # Tag the jobs image as staging:latest for Cloud Run jobs to use
          gcloud artifacts docker tags add \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:staging

  # ============================================
  # Stage 4: E2E Tests against Staging (ALL tests)
  # ============================================
  e2e-tests-staging:
    needs: deploy-staging
    if: always() && needs.deploy-staging.result == 'success'
    runs-on: ubuntu-latest
    env:
      # Slack configuration (Pattern: {SERVICE}_{ENV}_*)
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_STAGING_BOT_TOKEN }}
      SLACK_USER_TOKEN: ${{ secrets.SLACK_STAGING_USER_TOKEN }}
      SLACK_SIGNING_SECRET: ${{ secrets.SLACK_STAGING_SIGNING_SECRET }}
      # E2E test configuration
      E2E_TEST_CHANNEL_ID: ${{ secrets.E2E_STAGING_TEST_CHANNEL_ID }}
      E2E_BOT_USER_ID: ${{ secrets.E2E_STAGING_BOT_USER_ID }}
      E2E_ADMIN_CHANNEL: ${{ secrets.E2E_STAGING_ADMIN_CHANNEL_ID }}
      KNOWLEDGE_ADMIN_CHANNEL: ${{ secrets.E2E_STAGING_ADMIN_CHANNEL_ID }}
      STAGING_BOT_URL: https://slack-bot-staging-4aosg235qq-uc.a.run.app
      # Graph Database Configuration (Graphiti + Neo4j)
      GRAPH_BACKEND: neo4j
      GRAPH_ENABLE_GRAPHITI: "true"
      NEO4J_URI: ${{ secrets.NEO4J_STAGING_URI }}
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${{ secrets.NEO4J_STAGING_PASSWORD }}
      # Anthropic API for Graphiti entity extraction
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_MODEL: claude-sonnet-4-20250514
      # Vertex AI for embeddings
      EMBEDDING_PROVIDER: vertex-ai
      VERTEX_AI_PROJECT: ai-knowledge-base-42
      VERTEX_AI_LOCATION: us-central1
      # LLM configuration
      LLM_PROVIDER: gemini
      GEMINI_MODEL_ID: gemini-2.0-flash
      GCP_PROJECT_ID: ai-knowledge-base-42
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -e .[dev]
      - name: Wait for staging to be ready
        run: sleep 30
      - name: Run ALL E2E tests against staging
        run: |
          pip install pytest-timeout
          # Use timeout to force pytest to exit (it can hang after tests complete due to async cleanup)
          timeout --signal=SIGKILL 10m pytest tests/e2e/ -v -m e2e --tb=short --timeout=300 || {
            exit_code=$?
            # Exit code 137 means SIGKILL from timeout, which is OK if tests passed
            # Exit code 124 means timeout sent SIGTERM first
            if [ $exit_code -eq 137 ] || [ $exit_code -eq 124 ]; then
              echo "::warning::pytest was killed by timeout (likely hung during cleanup)"
              exit 0
            fi
            exit $exit_code
          }
        timeout-minutes: 15

  # ============================================
  # Stage 5: Deploy to Production (main only)
  # ============================================
  deploy-production:
    needs: e2e-tests-staging
    if: always() && needs.e2e-tests-staging.result == 'success' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy slack-bot to production
        env:
          TAG: ${{ github.sha }}
        run: |
          gcloud run deploy slack-bot \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/slack-bot:$TAG \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}
      - name: Tag jobs image as latest for production
        env:
          TAG: ${{ github.sha }}
        run: |
          # Tag the jobs image as latest for production Cloud Run jobs
          gcloud artifacts docker tags add \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:$TAG \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/knowledge-base/jobs:latest
